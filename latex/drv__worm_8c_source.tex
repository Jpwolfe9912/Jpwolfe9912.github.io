\hypertarget{drv__worm_8c_source}{}\doxysection{drv\+\_\+worm.\+c}
\label{drv__worm_8c_source}\index{/Users/jeremywolfe/Documents/STM32CubeIDE/Autodrone32/Src/drv/drv\_worm.c@{/Users/jeremywolfe/Documents/STM32CubeIDE/Autodrone32/Src/drv/drv\_worm.c}}
\mbox{\hyperlink{drv__worm_8c}{Go to the documentation of this file.}}
\begin{DoxyCode}{0}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00001}00001 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00010}00010 \textcolor{comment}{/* Includes */}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00011}00011 \textcolor{preprocessor}{\#include "{}\mbox{\hyperlink{board_8h}{board.h}}"{}}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00012}00012 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00013}00013 \textcolor{comment}{/* Global Variables */}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00014}\mbox{\hyperlink{drv__worm_8c_ace909de44fd65d7cc09fe9d11178fb43}{00014}} \textcolor{keywordtype}{bool} \mbox{\hyperlink{drv__worm_8c_ace909de44fd65d7cc09fe9d11178fb43}{arm1Hit}} = \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00015}\mbox{\hyperlink{drv__worm_8c_a96647bc245d39fa8c5c78abdf530cf19}{00015}} \textcolor{keywordtype}{bool} \mbox{\hyperlink{drv__worm_8c_a96647bc245d39fa8c5c78abdf530cf19}{arm2Hit}} = \textcolor{keyword}{false};}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00016}00016 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00021}00021 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00022}\mbox{\hyperlink{drv__worm_8c_a52927cc2126ccc2c38edb697a9cc420f}{00022}} \mbox{\hyperlink{drv__worm_8c_a52927cc2126ccc2c38edb697a9cc420f}{wormInit}}(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00023}00023 \{}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00024}00024     RCC-\/>AHB1ENR    |= RCC\_AHB1ENR\_GPIOAEN;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00025}00025     RCC-\/>AHB1ENR    |= RCC\_AHB1ENR\_GPIOCEN;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00026}00026     RCC-\/>APB2ENR    |= RCC\_APB2ENR\_SYSCFGEN;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00027}00027     RCC-\/>APB2ENR    |= RCC\_APB2ENR\_TIM1EN;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00028}00028 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00029}00029     \textcolor{comment}{/* GPIOA Initialization */}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00030}00030     \textcolor{comment}{// PA8 as TIM1 CH1}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00031}00031     GPIOA-\/>MODER    \&= \string~GPIO\_MODER\_MODER8;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00032}00032     GPIOA-\/>MODER    |= GPIO\_MODER\_MODER8\_1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00033}00033     GPIOA-\/>OSPEEDR  |= GPIO\_OSPEEDR\_OSPEEDR8;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00034}00034     GPIOA-\/>OTYPER   \&= \string~GPIO\_OTYPER\_OT8;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00035}00035     GPIOA-\/>AFR[1]   \&= \string~GPIO\_AFRH\_AFRH0;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00036}00036     GPIOA-\/>AFR[1]   |= (0x1 << 0U);}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00037}00037     \textcolor{comment}{// PA9 as TIM1 CH2}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00038}00038     GPIOA-\/>MODER    \&= \string~GPIO\_MODER\_MODER9;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00039}00039     GPIOA-\/>MODER    |= GPIO\_MODER\_MODER9\_1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00040}00040     GPIOA-\/>OSPEEDR  |= GPIO\_OSPEEDR\_OSPEEDR9;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00041}00041     GPIOA-\/>OTYPER   \&= \string~GPIO\_OTYPER\_OT9;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00042}00042     GPIOA-\/>AFR[1]   \&= \string~GPIO\_AFRH\_AFRH1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00043}00043     GPIOA-\/>AFR[1]   |= (0x1 << 4U);}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00044}00044     \textcolor{comment}{// PC8 as output and pulled down}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00045}00045     GPIOC-\/>MODER    |= GPIO\_MODER\_MODER8\_0;;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00046}00046     GPIOC-\/>PUPDR    |= GPIO\_PUPDR\_PUPDR8\_1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00047}00047     \textcolor{comment}{// PC9 as output and pulled down}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00048}00048     GPIOC-\/>MODER    |= GPIO\_MODER\_MODER9\_0;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00049}00049     GPIOC-\/>PUPDR    |= GPIO\_PUPDR\_PUPDR9\_1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00050}00050     \textcolor{comment}{// PC13 as input and pulled down}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00051}00051     GPIOC-\/>MODER    \&= \string~GPIO\_MODER\_MODER13;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00052}00052     GPIOC-\/>PUPDR    |= GPIO\_PUPDR\_PUPDR13\_1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00053}00053     \textcolor{comment}{// PC14 as input and pulled down}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00054}00054     GPIOC-\/>MODER    \&= \string~GPIO\_MODER\_MODER14;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00055}00055     GPIOC-\/>PUPDR    |= GPIO\_PUPDR\_PUPDR14\_1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00056}00056 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00057}00057     \textcolor{comment}{/* TIM1 Initialization */}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00058}00058     TIM1-\/>CCMR1     \&= \string~TIM\_CCMR1\_OC1M;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00059}00059     TIM1-\/>CCMR1     |= TIM\_CCMR1\_OC1M\_1 | TIM\_CCMR1\_OC1M\_2;     \textcolor{comment}{// enable CH1 as PWM mode on CCMR1}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00060}00060     TIM1-\/>BDTR      |= TIM\_BDTR\_MOE;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00061}00061     TIM1-\/>CCER      \&= \string~TIM\_CCER\_CC1E;                          \textcolor{comment}{// enables channel 1 as output}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00062}00062 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00063}00063     TIM1-\/>CCMR1     \&= \string~TIM\_CCMR1\_OC2M;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00064}00064     TIM1-\/>CCMR1     |= TIM\_CCMR1\_OC2M\_1 | TIM\_CCMR1\_OC2M\_2;     \textcolor{comment}{// enable CH1 as PWM mode on CCMR1}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00065}00065     TIM1-\/>CCER      \&= \string~TIM\_CCER\_CC2E;                          \textcolor{comment}{// enables channel 1 as output}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00066}00066 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00067}00067     TIM1-\/>PSC       = 0;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00068}00068     TIM1-\/>ARR       = 5082 -\/ 1;         \textcolor{comment}{// 42.5kHz}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00069}00069     TIM1-\/>BDTR      |= TIM\_BDTR\_MOE;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00070}00070     TIM1-\/>CNT       = 0;                \textcolor{comment}{// start the counter at 0}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00071}00071     TIM1-\/>CR1       |= TIM\_CR1\_CEN;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00072}00072 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00073}00073     \textcolor{comment}{/* GPIO IRQ Initialization */}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00074}00074     SYSCFG-\/>EXTICR[3]   |= SYSCFG\_EXTICR4\_EXTI13\_PC |}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00075}00075                            SYSCFG\_EXTICR4\_EXTI14\_PC;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00076}00076     EXTI-\/>RTSR          |= EXTI\_RTSR\_TR13 |}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00077}00077                            EXTI\_RTSR\_TR14;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00078}00078 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00079}00079     NVIC\_SetPriority(EXTI15\_10\_IRQn, 0);}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00080}00080     NVIC\_EnableIRQ(EXTI15\_10\_IRQn);}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00081}00081 \}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00082}00082 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00087}00087 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00088}\mbox{\hyperlink{drv__worm_8c_af49714c5dce3faf11f37587b54974d24}{00088}} \mbox{\hyperlink{drv__worm_8c_af49714c5dce3faf11f37587b54974d24}{wormDrive}}(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00089}00089 \{}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00090}00090     \textcolor{keywordtype}{float} speed = 0.8;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00091}00091 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00092}00092     EXTI-\/>IMR       \&= \string~(EXTI\_IMR\_IM13 |    \textcolor{comment}{// turn off GPIO interrupts}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00093}00093                          EXTI\_IMR\_IM14);}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00094}00094     TIM1-\/>CCER      |= TIM\_CCER\_CC1E |      \textcolor{comment}{// enables channel 1 as output}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00095}00095                        TIM\_CCER\_CC2E;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00096}00096 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00097}00097     \textcolor{keywordflow}{if}(\mbox{\hyperlink{process__commands_8c_abdda914a8c6ac0445832f7dbf4f37286}{mode}} == \mbox{\hyperlink{_autodrone32_8h_ada81cad6f64bf0042dba36096bf32710a8ff0f0e920a26f5210452e85eabc54d3}{TRANS\_FLIGHT}})}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00098}00098     \{}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00099}00099         GPIOC-\/>BSRR |= GPIO\_BSRR\_BR8;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00100}00100         TIM1-\/>CCR1 = (uint32\_t)(5082 * speed) -\/ 1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00101}00101 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00102}00102         GPIOC-\/>BSRR |= GPIO\_BSRR\_BS9;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00103}00103         TIM1-\/>CCR2 = (uint32\_t)(5082 * speed) -\/ 1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00104}00104     \}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00105}00105     \textcolor{keywordflow}{else} \textcolor{keywordflow}{if}(\mbox{\hyperlink{process__commands_8c_abdda914a8c6ac0445832f7dbf4f37286}{mode}} == \mbox{\hyperlink{_autodrone32_8h_ada81cad6f64bf0042dba36096bf32710a8dc5461871ae730fcc0b532526747d60}{TRANS\_ROVER}})}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00106}00106     \{}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00107}00107         GPIOC-\/>BSRR |= GPIO\_BSRR\_BS8;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00108}00108         TIM1-\/>CCR1 = (uint32\_t)(5082 * speed) -\/ 1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00109}00109 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00110}00110         GPIOC-\/>BSRR |= GPIO\_BSRR\_BR9;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00111}00111         TIM1-\/>CCR2 = (uint32\_t)(5082 * speed) -\/ 1;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00112}00112     \}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00113}00113     \textcolor{keywordflow}{else}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00114}00114     \{}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00115}00115         TIM1-\/>CCR1 = 0;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00116}00116         TIM1-\/>CCR2 = 0;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00117}00117     \}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00118}00118 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00119}00119     \mbox{\hyperlink{drv__system_8c_a7f2dfce1046bdd2a2b753643726c2346}{delay}}(1000);}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00120}00120     EXTI-\/>IMR       |= EXTI\_IMR\_IM13 |      \textcolor{comment}{// wait for arm to be clear of limit switch}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00121}00121                        EXTI\_IMR\_IM14;       \textcolor{comment}{// and then turn interrupts back on}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00122}00122 \}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00123}00123 }
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00124}00124 \textcolor{keywordtype}{void}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00125}\mbox{\hyperlink{drv__worm_8c_a738473a5b43f6c92b80ce1d3d6f77ed9}{00125}} \mbox{\hyperlink{drv__worm_8c_a738473a5b43f6c92b80ce1d3d6f77ed9}{EXTI15\_10\_IRQHandler}}(\textcolor{keywordtype}{void})}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00126}00126 \{}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00127}00127     \textcolor{keywordflow}{if}(EXTI-\/>PR \& EXTI\_PR\_PR13)\{}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00128}00128         EXTI-\/>PR |= EXTI\_PR\_PR13;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00129}00129         TIM1-\/>CCER \&= \string~TIM\_CCER\_CC1E;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00130}00130         \mbox{\hyperlink{drv__worm_8c_ace909de44fd65d7cc09fe9d11178fb43}{arm1Hit}} = \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00131}00131     \}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00132}00132     \textcolor{keywordflow}{if}(EXTI-\/>PR \& EXTI\_PR\_PR14)\{}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00133}00133         EXTI-\/>PR |= EXTI\_PR\_PR14;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00134}00134         TIM1-\/>CCER \&= \string~TIM\_CCER\_CC2E;}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00135}00135         \mbox{\hyperlink{drv__worm_8c_a96647bc245d39fa8c5c78abdf530cf19}{arm2Hit}} = \textcolor{keyword}{true};}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00136}00136     \}}
\DoxyCodeLine{\Hypertarget{drv__worm_8c_source_l00137}00137 \}}

\end{DoxyCode}
